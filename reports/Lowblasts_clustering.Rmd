---
title: "Clustering low-blasts"
author: "Carlos Ruiz"
date: "`r Sys.Date()`"
output:
  rmdformats::downcute:
    toc_depth: 3
    downcute_theme: "default"
    lightbox: true
    thumbnails: true
    gallery: true
    use_bookdown: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Preparación

```{r}
library(MASS)
library(cluster)
library(rpart)
library(ca)
library(cowplot)
library(pheatmap)
library(survminer)
library(survival)
library(tidyverse)
```

```{r}
load("../results/clustering/lowblast_pc_clustering.Rdata")
load("../results/clustering/lowblast_pc_clustering_raw.Rdata")
```

```{r}
kar_events <- c("delY", "del11q", "del20q", "del7q",  "plus8",  "del7")
sel_muts <- c("TET2", "ASXL1", "SRSF2", "DNMT3A", "RUNX1", 
              "STAG2", "U2AF1", "EZH2", "ZRSR2", "TET2bi", "TET2other")
```

## Clustering

La definición de los sub-grupos se realizó siguiendo los siguientes pasos:

1.  Reducción de la dimensionalidad por tipo de dato
2.  Reducción de la dimensionalidad conjunta
3.  Definición de clusters con K-means
4.  Refinamiento a través de la clasificación

### Reducción de la dimensionalidad por tipo de dato

Se redujo la dimensionalidad de los datos de manera independiente para los datos clínicos, de kariotipo y de mutaciones.

Datos clínicos: se aplicó un PCA (Principal Component Analysis). Previamente, se aplicó un log a los valores de plaquetas y todos los valores se escalaron.

Kariotipo: los datos de kariotipo están definidos como variables binarias (0 ausente, 1 presente). En este caso, se aplicó CA (Correspondance Analysis), una técnica con el mismo objetivo pero más adecuada para este tipo de variable. Previamente, se filtraron las `r length(kar_events)` aberraciones kariotípicas con una frecuencia \<1% en los low blasts.

Mutaciones: los datos de mutaciones también están definidos como variables binarias, por lo que también se aplicó CA (Correspondance Analysis). Previamente, se filtraron las `r length(sel_muts)` mutaciones con una frecuencia \<5% en los low blasts.

### Reducción de la dimensionalidad conjunta

Para hacer un clustering conjunto, seleccionamos los componentes que explican alrededor de un 80% de la variabilidad en cada tipo de dato. Así, cogimos 4 PCs de las variables clínicas, 3 PCs de los kariotipos y 5 PCs de las mutaciones.

Combinamos estos PCs en una matriz y volvimos a correr un PCA. Este PCA nos da componentes que recogen información de los datos clínicos, kariotipos y mutaciones.

### Definición de clusters con K-means

A continuación, definimos los clusters con k-means. Para definir el número de clusters, maximizamos el criterio de silhouette. Silhouette es una medida que nos dice, para cada muestra, como de bien clusterizada está. El mejor valor fueron 7 clusters.

```{r}
data.frame(N_clusters = 2:20, Score = sil_scores) %>%
  mutate(color = ifelse(N_clusters == 7, "rest", "selected")) %>%
  ggplot(aes(x = N_clusters, y = Score)) +
  geom_point(aes(color = color)) +
  geom_line() +
  scale_color_manual(values = c("red", "black")) +
  xlab("Number of clusters") +
  ylab("Silhouette Score") +
  theme_bw() +
  theme(legend.position = "none") 
```

### Refinamiento a través de la clasificación

Finalmente, refinamos la definición de los clusters basándonos en un clasificador en árbol. En este paso, lo que hicimos es definir un árbol para clasificar los pacientes y coger la clasificación que da el árbol como la clasificación buena. Repetimos este proceso varias veces hasta que convergió.

En resumen, con este proceso definimos 7 clusters que se caracterizan por lo siguiente:

-   Baja proporción de células blancas
-   Alta proporción de células blancas
-   TET2 bialélico
-   TET2 monoalélico
-   8+
-   del20q
-   Y-

## Exploración de los datos

PCA de los datos clínicos

```{r}
df_clin <- data.frame(clin_pc$x[, 1:4])
colnames(df_clin) <- paste0("PC", 1:4)
df_clin$cluster <- clinical_low$clust
group_cols <- c("#E69F00", "#56B4E9", "#009E73", 
                                "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

scale <-   scale_color_manual(values = group_cols) 
scale_fill <-   scale_fill_manual(values = group_cols) 
p1 <- ggplot(df_clin, aes(x = PC1, y = PC2, col = cluster)) +
        geom_point() +
        xlab("PC1 (32.9%)") +
        ylab("PC2 (17.2%)") +
        scale + 
        theme_bw()
p2 <- ggplot(df_clin, aes(x = PC3, y = PC4, col = cluster)) +
        geom_point() +
        xlab("PC3 (14.4%)") +
        scale + 
        ylab("PC4 (13.4%)") +
        theme_bw()
plot_grid(p1, p2, ncol = 2)
```

CA de los kariotipos

```{r}
df_kar <- data.frame(kar_pca$rowcoord[, 1:4])
colnames(df_kar) <- paste0("CA", 1:4)
df_kar$cluster <- clinical_low$clust
scale <-   scale_color_manual(values = c("#E69F00", "#56B4E9", "#009E73", 
                                "#F0E442", "#0072B2", "#D55E00", "#CC79A7")) 
p1 <- ggplot(df_kar, aes(x = CA1, y = CA2, col = cluster)) +
        geom_jitter(width = 0.2, height = 0.2) +
        xlab("CA1 (32.9%)") +
        ylab("CA2 (27.2%)") +
        scale + 
        theme_bw()
p2 <- ggplot(df_kar, aes(x = CA3, y = CA4, col = cluster)) +
        geom_jitter(width = 0.2, height = 0.2) +
        xlab("CA3 (20.0%)") +
        scale + 
        ylab("CA4 (11.8%)") +
        theme_bw()
plot_grid(p1, p2, ncol = 2)
```

CA de las mutaciones

```{r}
df_mut <- data.frame(mut_pca$rowcoord[, 1:4])
colnames(df_mut) <- paste0("CA", 1:4)
df_mut$cluster <- clinical_low$clust
scale <-   scale_color_manual(values = c("#E69F00", "#56B4E9", "#009E73", 
                                "#F0E442", "#0072B2", "#D55E00", "#CC79A7")) 
p1 <- ggplot(df_mut, aes(x = CA1, y = CA2, col = cluster)) +
        geom_jitter(width = 0.2, height = 0.2) +
        xlab("CA1 (27.4%)") +
        ylab("CA2 (16.1%)") +
        scale + 
        theme_bw()
p2 <- ggplot(df_mut, aes(x = CA3, y = CA4, col = cluster)) +
        geom_jitter(width = 0.2, height = 0.2) +
        xlab("CA3 (15.2%)") +
        scale + 
        ylab("CA4 (13.4%)") +
        theme_bw()
plot_grid(p1, p2, ncol = 2)
```

PCA combinado

```{r}
df_comb <- data.frame(comb_pc$x[, 1:4])
colnames(df_comb) <- paste0("PC", 1:4)
df_comb$cluster <- clinical_low$clust
p1 <- ggplot(df_comb, aes(x = PC1, y = PC2, col = cluster)) +
        geom_point() +
        xlab("PC1 (16.2%)") +
        ylab("PC2 (10.0%)") +
        scale + 
        theme_bw()
p2 <- ggplot(df_comb, aes(x = PC3, y = PC4, col = cluster)) +
        geom_point() +
        xlab("PC3 (10.0%)") +
        scale + 
        ylab("PC4 (9.0%)") +
        theme_bw()
plot_grid(p1, p2, ncol = 2)
```

## Correlación con variables usadas en el clustering

### Variables clínicas

```{r}
clin_vars <- c("BM_BLAST", "PB_BLAST", "WBC", "ANC", "MONOCYTES", "HB", "logPLT")
names(clin_vars) <- clin_vars
```

Check for overdispersion

```{r}
vmrs <- sapply(clin_vars[clin_vars != "logPLT"] , function(clin){
 
  model <- glm.nb(formula(paste(clin, " ~ clust + SEX + AGE")), 
              clinical_low)
  observed_variance <- var(clinical_low[[clin]], na.rm = TRUE)
  observed_mean <- mean(clinical_low[[clin]], na.rm = TRUE)
  vmr <- observed_variance / observed_mean
})
vmrs
```

```{r}

names(clin_vars) <- clin_vars
clinical_low$logPLT <- clinical_low$PLT
low_clin_plots <- lapply(clin_vars, function(var){
    ggplot(clinical_low, aes(x = .data[[var]])) +
        geom_histogram() +
        facet_grid(clust ~ .) +
        theme_bw()
})
```

```{r, fig.width=6, fig.height=6}
plot_grid(plotlist = low_clin_plots[1:3], nrow = 1)
plot_grid(plotlist = low_clin_plots[4:6], nrow = 1)
plot_grid(plotlist = low_clin_plots[7], nrow = 1)
```

```{r, fig.height=10, fig.width=10}
clinical_low %>%
    select(all_of(clin_vars), clust) %>%
    pivot_longer(cols = !clust, names_to = "Cell", values_to = "value") %>%
  mutate(Cell = factor(Cell, levels = clin_vars)) %>%
  ggplot(aes(x = value, color = clust)) +
  geom_density() +
  scale +
  facet_wrap(~ Cell, scale = "free") +
  theme_bw()
```

```{r}
clinical_low %>%
    select(ANC, PB_BLAST, WBC, ANC, MONOCYTES, clust) %>%
    pivot_longer(cols = !clust, names_to = "Cell", values_to = "value") %>%
    mutate(category = cut(value, breaks = c(-0.1, 1, 2, 3, 4, 5, 10, 20), 
                            labels = c("0", "1", "2", "3", "4", "5-10", "10+"))) %>%
    group_by(Cell, category, clust) %>%
    summarize(n_cat = n()) %>%
    group_by(Cell, clust) %>%
    mutate(prop = n_cat/sum(n_cat)) %>%
  ggplot(aes(x = clust, y = prop, fill = category)) +
    geom_bar(stat = "identity") +
    facet_wrap(~ Cell) +
    ylab("Proportion") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


```

```{r}
clinical_low %>%
    select(HB, logPLT, clust) %>%
    pivot_longer(cols = !clust, names_to = "Cell", values_to = "value") %>%
    ggplot(aes(y = value, x = clust)) + 
    geom_violin() +
    facet_wrap(~Cell, scales = "free_y") +
    theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

Variables with poisson distribution

```{r}
clusters <- levels(clinical_low$clust)
poisson <- c("BM_BLAST", "WBC", "ANC", "MONOCYTES")
names(poisson) <- c("BM_BLAST", "WBC", "ANC", "MONOCYTES")
res <- lapply(poisson, function(var){
    cell_test <- lapply(seq_len(length(clusters) - 1), function(i){
      cl <- clusters[i]
     tmp <- mutate(clinical_low, cluster = relevel(clust, cl))
     poiss_lm <- summary(glm(formula (paste(var, " ~ cluster + SEX + AGE")), tmp, 
                      family = "poisson"))
     coefs <- poiss_lm$coefficients[-1, ]
     coef_df <- as_tibble(coefs[, c(1, 4)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(Estimate))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
  out <- mutate(cell_test, 
                Cell = var) %>%
    filter(P_value < 0.05 & HR > 1 & !Comp_clust %in% c("AGE", "SEXM")   ) %>%
    arrange(P_value)
  out
})
res

```

Variables with negative binomial distribution

```{r}
pb_res <- lapply(seq_len(length(clusters) - 1), function(i){
      cl <- clusters[i]
     tmp <- mutate(clinical_low, cluster = relevel(clust, cl))
     nb_lm <- summary(glm.nb(PB_BLAST ~ cluster + SEX + AGE, tmp))
     coefs <- nb_lm$coefficients[-1, ]
     coef_df <- as_tibble(coefs[, c(1, 4)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(Estimate))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
mutate(pb_res, Cell = "PB_BLAST") %>%
    filter(P_value < 0.05 & HR > 1) %>%
    arrange(P_value)
```

Variables modeled with a normal

```{r}
normal <- c("HB", "logPLT")
names(normal) <- normal
norm_res <- lapply(normal, function(var){
    cell_test <- lapply(seq_len(length(clusters) - 1), function(i){
      cl <- clusters[i]
     tmp <- mutate(clinical_low, cluster = relevel(clust, cl))
     lm <- summary(lm(formula (paste(var, " ~ cluster + SEX + AGE")), tmp))
     coefs <- lm$coefficients[-1, ]
     coef_df <- as_tibble(coefs[, c(1, 4)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              Beta = Estimate)
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, Beta, P_value)
    }) %>%
    Reduce(., f = rbind) 
  out <- mutate(cell_test, 
                Cell = var) %>%
    filter(P_value < 0.05 & Beta > 0 & !Comp_clust %in% c("AGE", "SEX")   ) %>%
    arrange(P_value)
  out
})
norm_res

```

Se ven numerosas diferencias entre los clusters en las variables clínicas. 

### Kariotipos

```{r}
clinical_low$complex <- factor(clinical_low$complex, levels = c("non-complex", "complex"))
kar_events <- c(kar_events, "complex")
names(kar_events) <- kar_events
kar_tabs <- lapply(kar_events, function(x) table(clinical_low[[x]], clinical_low$clust))
kar_tabs_lowblasts <- sapply(kar_tabs, function(x) prop.table(x, margin = 2)[2, ])*100

pheatmap(mat = kar_tabs_lowblasts, display_numbers = TRUE)


```

La figura muestra la proporción de individuos de un cluster que tienen el evento kariotípico. En los clusters definidos por eventos kariotípicos (del20q, 8+ y Y-), todos los pacientes tienen el evento. No obstante, estos eventos también pueden estar en individuos de otros clusteres. Los otros eventos no muestran una distribución particular en ningún cluster.

### Mutaciones

```{r}
names(sel_muts) <- sel_muts
mut_tabs <- lapply(sel_muts, function(x) table(clinical_low[[x]], clinical_low$clust))

mut_tabs_lowblasts <- sapply(mut_tabs, function(x) prop.table(x, margin = 2)[2, ])*100
pheatmap(mat = mut_tabs_lowblasts, display_numbers = TRUE)
```
La figura muestra la proporción de individuos de un cluster que tienen la mutación. En los clusters definidos por mutaciones en TET2, todos los pacientes tienen la mutación. No obstante, también hay pacientes con TET2 mono-alélica en pacientes 8+ y con TET2 bi-alélica en pacientes con High WBC y Y-. Las otras mutaciones también presentan perfiles diferenciados.

```{r}
mut_res <- lapply(sel_muts[-grep("TET2*", sel_muts)], function(mut){
    cell_test <- lapply(seq_len(length(clusters) - 1), function(i){
      cl <- clusters[i]
     tmp <- mutate(clinical_low, cluster = relevel(clust, cl))
     mut_binom <- summary(glm(formula (paste(mut, " ~ cluster + SEX + AGE")), tmp, 
                      family = "binomial"))
     coefs <- mut_binom$coefficients[-1, ]
     coef_df <- as_tibble(coefs[, c(1, 4)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(Estimate))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
  out <- mutate(cell_test, 
                Mutation = mut) %>%
    filter(P_value < 0.05 & HR > 1 & !Comp_clust %in% c("AGE", "SEXM")   ) %>%
    arrange(P_value)
  out
})
mut_res
```

## Correlación con variables externas

### Edad

```{r}
ggplot(clinical_low, aes(x = AGE)) +
        geom_histogram() +
        facet_grid(clust ~ .) +
        theme_bw()
```

```{r}
clinical_low %>%
  ggplot(aes(x = AGE, color = clust)) +
  geom_density() +
  scale +
  theme_bw()
```


```{r}
clinical_low %>%
    ggplot(aes(y = AGE, x = clust)) + 
    geom_violin() +
    theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

```{r}
age_test <- lapply(clusters, function(cl){
     tmp <- mutate(clinical_low, cluster = relevel(clust, cl))
     lm <- summary(lm(AGE ~ cluster + SEX, tmp))
     coefs <- lm$coefficients[-1, ]
     coef_df <- as_tibble(coefs[, c(1, 4)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              Beta = Estimate)
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, Beta, P_value)
    }) %>%
    Reduce(., f = rbind) 
age_test %>%
    filter(P_value < 0.05 & Beta > 0 & !Comp_clust %in% "SEXM"   ) %>%
    arrange(P_value)

```

Los pacientes 8+ y low WBC son más jóvenes que el resto.

### Sexo

```{r}
sex_prop <- prop.table(table(clinical_low$clust, clinical_low$SEX), margin = 1)
sex_prop_df <- tibble(cluster = rownames(sex_prop), propF = sex_prop[, 1])
chisq.test(table(clinical_low$clust, clinical_low$SEX))
```

```{r}
ggplot(sex_prop_df, aes(y = propF*100, x = cluster)) +
        geom_bar(stat = "identity") +
        theme_bw() +
        geom_hline(yintercept = mean(clinical_low$SEX == "F")*100,
            linetype = "dashed") +
            ylab("Proportion of Females") 

```

```{r}
sex_test <- lapply(clusters[clusters != "Y-"], function(cl){
     tmp <- mutate(clinical_low, cluster = relevel(clust, cl)) %>%
       filter(cluster != "Y-") %>%
       mutate(cluster = droplevels(cluster),
              SEX = ifelse(SEX == "M", 1, 0))
     binom <- summary(glm(SEX ~ cluster + AGE, tmp, family = "binomial"))
     coefs <- binom$coefficients[-1, ]
     coef_df <- as_tibble(coefs[, c(1, 4)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(Estimate))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
sex_test %>%
    filter(P_value < 0.05 & HR > 1 & !Comp_clust %in% "AGE"   ) %>%
    arrange(P_value)

```
Hay más mujeres en los TET2 que en los High WBC. En el resto de clusters, las diferencias no son significativas.



### IPSSM

```{r}
table(clinical_low$clust, clinical_low$IPSSM) %>%
    as.matrix() %>%
    pheatmap(display_numbers = TRUE, cluster_cols = FALSE)
```

Número de individuos por grupo IPSSM

```{r}
clist_ipssm_mat_prop <- prop.table(table(clinical_low$clust, clinical_low$IPSSM), margin = 1) %>%
    as.matrix()*100 
pheatmap(clist_ipssm_mat_prop, display_numbers = TRUE, cluster_cols = FALSE)
```

Proporción de individuos en cada grupo IPSSM. Los pacientes del 8+ son los que están clasificados como peor riesgo.

### IPSSM score performance

```{r}
ggplot(clinical_low, aes(x = OV_C_INDEX)) +
        geom_histogram() +
        facet_grid(clust ~ .) +
        theme_bw()

ggplot(clinical_low, aes(x = SUB_C_INDEX)) +
        geom_histogram() +
        facet_grid(clust ~ .) +
        theme_bw()
```
```{r}
clinical_low %>%
  ggplot(aes(x = OV_C_INDEX, color = clust)) +
  geom_density() +
  scale +
  theme_bw()

clinical_low %>%
  ggplot(aes(x = SUB_C_INDEX, color = clust)) +
  geom_density() +
  scale +
  theme_bw()
```

```{r}
clinical_low %>%
    ggplot(aes(y = OV_C_INDEX, x = clust)) + 
    geom_violin() +
    theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

clinical_low %>%
    ggplot(aes(y = SUB_C_INDEX, x = clust)) + 
    geom_violin() +
    theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


```{r}
ov_c_test <- lapply(clusters, function(cl){
     tmp <- mutate(clinical_low, cluster = relevel(clust, cl),
                   OV_C_TRANS = asin(sqrt(OV_C_INDEX - 1e-4)))
     lm <- summary(lm(OV_C_TRANS ~ cluster + SEX + AGE + IPSSM, tmp))
     coefs <- lm$coefficients[-1, ]
     coef_df <- as_tibble(coefs[, c(1, 4)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              Beta = Estimate)
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, Beta, P_value)
    }) %>%
    Reduce(., f = rbind) 
ov_c_test %>%
    filter(P_value < 0.05 & Beta > 0 & !Comp_clust %in% c("SEXM", "AGE")   ) %>%
    arrange(P_value)

```

```{r}
sub_c_test <- lapply(clusters, function(cl){
     tmp <- mutate(clinical_low, 
                   cluster = relevel(clust, cl),
                   OV_C_TRANS = ifelse(SUB_C_INDEX == 0, 1e-4, 
                                       ifelse(SUB_C_INDEX == 1, 1-1e-4, SUB_C_INDEX)),
                   OV_C_TRANS = asin(sqrt(OV_C_TRANS)))
     lm <- summary(lm(OV_C_TRANS ~ cluster + SEX + AGE + IPSSM, tmp))
     coefs <- lm$coefficients[-1, ]
     coef_df <- as_tibble(coefs[, c(1, 4)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              Beta = Estimate)
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, Beta, P_value)
    }) %>%
    Reduce(., f = rbind) 
sub_c_test %>%
    filter(P_value < 0.05 & Beta > 0 & !Comp_clust %in% c("SEXM", "AGE")   ) %>%
    arrange(P_value)

```

No se aprecian diferencias significativas después de ajustar por IPSSM.



### Supervivencia

Los análisis de supervivencia los hacemos solo con los clusters más grandes (Low WBC, High WBC, TET2 bi y TET2 mono) para tener un buen tamaño muestral. 

```{r}
main_clusts <- c("Low WBC", "High WBC", "TET2 mono", "TET2 bi")
names(main_clusts) <- main_clusts

main_low <- subset(clinical_low, clust %in% main_clusts) %>%
      mutate(clust = droplevels(clust))
```


```{r}
surv_low <- survfit(formula = Surv(OS_YEARS,OS_STATUS) ~ clust, main_low) %>%
    ggsurvplot(data = main_low, surv.median.line = "hv", 
               palette = group_cols)

surv_low$plot
```


```{r}
os_raw_test <- lapply(main_clusts, function(cl){
     tmp <- mutate(main_low, cluster = relevel(clust, cl))
     os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster + AGE + SEX , tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
os_raw_test %>%
    filter(HR > 1 & Comp_clust %in% main_clusts   ) %>%
    arrange(P_value)

```



```{r}
os_test <- lapply(main_clusts, function(cl){
     tmp <- mutate(main_low, cluster = relevel(clust, cl))
     os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster + AGE + SEX + IPSSM, tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
os_test %>%
    filter(HR > 1 & Comp_clust %in% main_clusts) %>%
    arrange(P_value)

```

En el modelo ajustado por IPSSM, TET2 bi-alélico es el que tiene peor supervivencia, aunque la diferencia solo es significativa con TET2 mono-alélico. TET2 mono tiene mejor supervivenica que el resto, mientras que High y Low WBC tienen la misma supervivencia.



### Transición a AML


```{r}
aml_low <- survfit(formula = Surv(AMLt_YEARS,AMLt_STATUS) ~ clust, main_low) %>%
    ggsurvplot(data = main_low, surv.median.line = "hv", 
               palette = group_cols)
aml_low$plot
```

```{r}
aml_raw_test <- lapply(main_clusts, function(cl){
     tmp <- mutate(main_low, cluster = relevel(clust, cl))
     aml <- summary(coxph(Surv(AMLt_YEARS, AMLt_STATUS) ~ cluster + AGE + SEX , tmp))
     coefs <- aml$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
aml_raw_test %>%
    filter(HR > 1 & Comp_clust %in% main_clusts) %>%
    arrange(P_value)

```
En el modelo sin ajustar, TET2 bi-alélico es el que tiene más riegos de transicionar a AML.

```{r}
aml_test <- lapply(main_clusts, function(cl){
     tmp <- mutate(main_low, cluster = relevel(clust, cl))
     aml <- summary(coxph(Surv(AMLt_YEARS,AMLt_STATUS) ~ cluster + AGE + SEX + IPSSM, tmp))
     coefs <- aml$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
aml_test %>%
    filter(HR > 1 & Comp_clust %in% main_clusts ) %>%
    arrange(P_value)

```

En el modelo ajustado por IPSSM, TET2 bi-alélico tiene más riesgo de transicionar a AML que el resto. 


## Interacción entre variables

### IPSSM vs supervivencia

```{r}
clinical_IPSSM <- mutate(main_low, 
                         IPSSM_col = ifelse(IPSSM %in% c("High", "Very-High"), "High/Very-High", 
                                            ifelse(grepl("Moderate", IPSSM), "Moderate", as.character(IPSSM))),
                         IPSSM_col = factor(IPSSM_col, levels = c("Very-Low", "Low", "Moderate", "High/Very-High")))
IPSSM_cats <- levels(clinical_IPSSM$IPSSM_col)
names(IPSSM_cats) <- IPSSM_cats


```

```{r}
survfit(formula = Surv(OS_YEARS,OS_STATUS) ~ clust, clinical_IPSSM) %>%
    ggsurvplot(data = clinical_IPSSM, surv.median.line = "hv", 
               palette = group_cols, facet.by = "IPSSM_col")

```



```{r}
os_ipssm_res <- lapply(IPSSM_cats, function(cat){
    ipssm_test <- lapply(main_clusts, function(cl){
    tmp <- subset(clinical_IPSSM, IPSSM_col == cat) %>%
      mutate(cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster + AGE + SEX, tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
  out <- mutate(ipssm_test, 
                IPSSM_cat = cat) %>%
    filter(HR > 1 & Comp_clust %in% main_clusts) %>%
    arrange(P_value)
  out
})
os_ipssm_res
```

TET2 bi tiene peor pronóstico especialmente para aquellos pacientes con IPSSM mayor de Low.

```{r}
ipssm_test2 <- lapply(main_clusts, function(cl){
    tmp <- subset(clinical_IPSSM, IPSSM_col %in% c("Moderate", "High/Very-High")) %>%
      mutate(cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster + AGE + SEX, tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
ipssm_test2 %>%
    filter(HR > 1 & Comp_clust %in% main_clusts) %>%
    arrange(P_value)
  

```




### IPSSM vs transición a AML


```{r}
survfit(formula = Surv(AMLt_YEARS,AMLt_STATUS) ~ clust, clinical_IPSSM) %>%
    ggsurvplot(data = clinical_IPSSM, surv.median.line = "hv", 
               palette = group_cols, facet.by = "IPSSM_col")


```

```{r}
aml_ipssm_res <- lapply(IPSSM_cats, function(cat){
    ipssm_test <- lapply(main_clusts, function(cl){
    tmp <- subset(clinical_IPSSM, IPSSM_col == cat) %>%
      mutate(cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(AMLt_YEARS,AMLt_STATUS) ~ cluster + AGE + SEX, tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
  out <- mutate(ipssm_test, 
                IPSSM_cat = cat) %>%
    filter(HR > 1 & Comp_clust %in% main_clusts) %>%
    arrange(P_value)
  out
})
aml_ipssm_res
```

TET2 bi-alélico tiene más riesgo de transicionar a AML, sobretodo a partir de riesgo mayor de Low. 

```{r}
ipssm_aml2 <- lapply(main_clusts, function(cl){
    tmp <- subset(clinical_IPSSM, IPSSM_col %in% c("Moderate", "High/Very-High")) %>%
      mutate(cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(AMLt_YEARS,AMLt_STATUS) ~ cluster + AGE + SEX, tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
ipssm_aml2 %>%
    filter(HR > 1 & Comp_clust %in% main_clusts) %>%
    arrange(P_value)
  

```

### IPSSM vs IPSSM score performance
```{r}
clinical_IPSSM %>%
  filter(!is.na(IPSSM_col)) %>%
  ggplot(aes(x = OV_C_INDEX, color = clust)) +
  geom_density() +
  scale +
  theme_bw() +
  facet_wrap(~ IPSSM_col, scales = "free_y")

clinical_IPSSM %>%
  filter(!is.na(IPSSM_col)) %>%
  ggplot(aes(x = SUB_C_INDEX, color = clust)) +
  geom_density() +
  scale +
  theme_bw() +
  facet_wrap(~ IPSSM_col, scales = "free_y")
```

```{r}
clinical_IPSSM %>%
  filter(!is.na(IPSSM_col)) %>%
  ggplot(aes(y = OV_C_INDEX, x = clust)) +
  geom_violin() +
  facet_wrap(~ IPSSM_col) +
  theme_bw()

clinical_IPSSM %>%
  filter(!is.na(IPSSM_col)) %>%
  ggplot(aes(y = SUB_C_INDEX, x = clust)) +
  geom_violin() +
  facet_wrap(~ IPSSM_col) +
  theme_bw()
```

### HMA treatment vs survival

Los análisis de tratamiento están hechos con los IPSSM Moderate-High, High y Very-High, para maximizar el número de pacientes con tratamiento.

```{r}
main_treat <- filter(main_low, IPSSM %in% c("Moderate-High", "High", "Very-High")) %>%
  mutate(IPSSM = droplevels(IPSSM),
         HMA = ifelse(hma == 0, "untreated", "hma"),
         HMA = factor(HMA, levels = c("untreated", "hma")),
         TRANSPLANT = ifelse(transplant == 0, "untransplanted", "transplanted"),
         TRANSPLANT = factor(TRANSPLANT, levels = c("untransplanted", "transplanted")))

chisq.test(table(main_treat$HMA, main_treat$clust))
table(main_treat$HMA, main_treat$clust, main_treat$IPSSM)
```

Los cuatro subgrupos están tratados de manera similar.

```{r}
survfit(formula = Surv(OS_YEARS,OS_STATUS) ~ HMA, main_treat) %>%
    ggsurvplot(data = main_treat, surv.median.line = "hv", 
               palette = group_cols, facet.by = "clust")

```


```{r}
hma_test <- lapply(main_clusts, function(cl){
    tmp <- mutate(main_treat,
            cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster*HMA + AGE + SEX + IPSSM, tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
hma_test %>%
    filter(HR > 1 & Comp_clust %in% paste0(main_clusts, ":HMAhma")) %>%
    arrange(P_value)
  
```
La mejor respuesta de hma es para High WBC. Los TET2 tienen la peor respuesta. 




### Transplante vs survival


```{r}
chisq.test(table(main_treat$TRANSPLANT, main_treat$clust))
table(main_treat$TRANSPLANT, main_treat$clust, main_treat$IPSSM)
```

Los cuatro subgrupos están tratados de manera similar.

```{r}
survfit(formula = Surv(OS_YEARS,OS_STATUS) ~ TRANSPLANT, main_treat) %>%
    ggsurvplot(data = main_treat, surv.median.line = "hv", 
               palette = group_cols, facet.by = "clust")

```


```{r}
transplant_test <- lapply(main_clusts, function(cl){
    tmp <- mutate(main_treat,
            cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster*TRANSPLANT + AGE + SEX + IPSSM, tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
transplant_test %>%
    filter(HR > 1 & Comp_clust %in% paste0(main_clusts, ":TRANSPLANTtransplanted")) %>%
    arrange(P_value)
  
```
No se ven diferencias significativas entre los grupos.

## Mutaciones

### Adjusted for IPSSM

```{r}
test_muts <- sel_muts[-grep("TET2", sel_muts)]
mut_hr_clust <- lapply(test_muts, function(gene){
    lapply(main_clusts, function(cl){
     covars <- " + AGE + IPSSM"
     if(cl != "Y-"){
       covars <- paste(covars, "+ SEX")
     }
        mod <- coxph(formula(paste("Surv(OS_YEARS,OS_STATUS) ~", gene, covars)), 
            main_low, subset = clust == cl)
        coef <- summary(mod)$coefficients
        hr <- exp(coef[1, 1])
        pval <- coef[1, 5]
        freq <- mean(main_low[[gene]][main_low$clust == cl])
        N <- sum(main_low[[gene]][main_low$clust == cl])
        data.frame(HR = hr, Pvalue = pval, Cluster = cl, Gene = gene, Freq = freq, N = N )
    }) %>% Reduce(f = rbind) %>%
        as_tibble()
}) %>% Reduce(f = rbind) 
```

```{r}
mut_hr_col <- mutate(mut_hr_clust,
                     HR = ifelse(N < 10, 1, HR),
                     Pvalue = ifelse(N < 10, 1, Pvalue),
    Sig = ifelse(Pvalue < 0.05, "Signif", "Not-signif"),
    Direction = ifelse(HR > 1, "Risk", "Protective"), 
    Color = factor( paste(Direction, Sig), levels = c("Protective Signif", "Protective Not-signif",
        "Risk Signif", "Risk Not-signif", "Undetermined")) )


mut_hr_col %>%
    filter(Gene %in% c("ASXL1", "DNMT3A", "RUNX1", "SRSF2", "U2AF1")) %>%
    ggplot(aes(x = Cluster, y = HR, fill = Color)) +
        geom_bar(stat = "identity") +
        theme_bw() +
        scale_y_continuous(transform = "log2") +
        facet_wrap(~ Gene, scales = "free_x") +
        scale_fill_manual(name = "", values = c("darkgreen", "darkred", "grey"))
```


### Adjusted for IPSSR

```{r}
mut_hr_clust2 <- lapply(test_muts, function(gene){
    lapply(main_clusts, function(cl){
     covars <- " + AGE + IPSSR"
     if(cl != "Y-"){
       covars <- paste(covars, "+ SEX")
     }
        mod <- coxph(formula(paste("Surv(OS_YEARS,OS_STATUS) ~", gene, covars)), 
            main_low, subset = clust == cl)
        coef <- summary(mod)$coefficients
        hr <- exp(coef[1, 1])
        pval <- coef[1, 5]
        freq <- mean(main_low[[gene]][main_low$clust == cl])
        N <- sum(main_low[[gene]][main_low$clust == cl])
        data.frame(HR = hr, Pvalue = pval, Cluster = cl, Gene = gene, Freq = freq, N = N )
    }) %>% Reduce(f = rbind) %>%
        as_tibble()
}) %>% Reduce(f = rbind) 
```

```{r}
mut_hr_col2 <- mutate(mut_hr_clust2,
                     HR = ifelse(N < 10, 1, HR),
                     Pvalue = ifelse(N < 10, 1, Pvalue),
    Sig = ifelse(Pvalue < 0.05, "Signif", "Not-signif"),
    Direction = ifelse(HR > 1, "Risk", "Protective"), 
    Color = factor( paste(Direction, Sig), levels = c("Protective Signif", "Protective Not-signif",
        "Risk Signif", "Risk Not-signif", "Undetermined")) )


mut_hr_col2 %>%
    filter(Gene %in% c("ASXL1", "DNMT3A", "RUNX1", "SRSF2", "U2AF1")) %>%
    ggplot(aes(x = Cluster, y = HR, fill = Color)) +
        geom_bar(stat = "identity") +
        theme_bw() +
        scale_y_continuous(transform = "log2") +
        facet_wrap(~ Gene, scales = "free_x") +
        scale_fill_manual(name = "", values = c("darkgreen", "darkred", "grey"))
```

### ASXL1

```{r}
asxl1_test <- lapply(main_clusts, function(cl){
    tmp <- mutate(main_low,
             cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster*ASXL1 + AGE + SEX + IPSSM, tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
asxl1_test %>%
    filter(HR > 1 & Comp_clust %in% paste0(main_clusts, ":ASXL1")   ) %>%
    arrange(P_value)
```



```{r}
asxl1_test2 <- lapply(main_clusts, function(cl){
    tmp <- mutate(main_low,
             cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster*ASXL1 + AGE + SEX + IPSSR, tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
asxl1_test2 %>%
    filter(HR > 1 & Comp_clust %in% paste0(main_clusts, ":ASXL1")   ) %>%
    arrange(P_value)
```

```{r}
asxl1_df <- main_low %>%
  mutate(ASXL1 = ifelse(ASXL1 == 1, "mutated", "WT")) 
survfit(formula = Surv(OS_YEARS,OS_STATUS) ~ ASXL1, data = asxl1_df) %>%
    ggsurvplot(data = asxl1_df, facet.by = "clust", 
               surv.median.line = "hv") 

```

```{r}
asxl1_raw_test <- lapply(main_clusts, function(cl){
    tmp <- mutate(main_low,
             cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster*ASXL1 + AGE + SEX, tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
asxl1_raw_test %>%
    filter(HR > 1 & Comp_clust %in% paste0(main_clusts, ":ASXL1")   ) %>%
    arrange(P_value)
```

```{r}
asxl1_df2 <- clinical_IPSSM %>%
  mutate(ASXL1 = ifelse(ASXL1 == 1, "mutated", "WT"),
         IPSSM_cat = ifelse(IPSSM_col %in% c("Very-Low", "Low"), "Very-Low/Low", "Moderate/High/Very-High")) 
lapply(c("Very-Low/Low", "Moderate/High/Very-High"), function(cat){
  tmp <- subset(asxl1_df2, IPSSM_cat == cat)
 survfit(formula = Surv(OS_YEARS,OS_STATUS) ~ ASXL1, data = tmp) %>%
    ggsurvplot(data = tmp, facet.by = "clust", 
               surv.median.line = "hv") +
   ggtitle(cat)
 
})
```

Se ve más claro el efecto de ASXL1 en Low WBC que en TET2 bi-alélico, a pesar de los tests estadísticos. 

### DNMT3A

```{r}
dnmt3a_test <- lapply(main_clusts, function(cl){
    tmp <- mutate(main_low,
             cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster*DNMT3A + AGE + SEX + IPSSM, tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
dnmt3a_test %>%
    filter(HR > 1 & Comp_clust %in% paste0(main_clusts, ":DNMT3A")   ) %>%
    arrange(P_value)
```
Solo hay diferencias con TET2 bi-alélico, que pueden ser debidas a la baja frecuencia de la mutación en este subtipo.



```{r}
dnmt3a_test2 <- lapply(main_clusts, function(cl){
    tmp <- mutate(main_low,
             cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster*DNMT3A + AGE + SEX + IPSSR, tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
dnmt3a_test2 %>%
    filter(HR > 1 & Comp_clust %in% paste0(main_clusts, ":DNMT3A")   ) %>%
    arrange(P_value)
```

```{r}
dnmt3a_df <- main_low %>%
  mutate(DNMT3A = ifelse(DNMT3A == 1, "mutated", "WT")) 
survfit(formula = Surv(OS_YEARS,OS_STATUS) ~ DNMT3A, data = dnmt3a_df) %>%
    ggsurvplot(data = dnmt3a_df, facet.by = "clust", 
               surv.median.line = "hv") 

```

```{r}
dnmt3a_df2 <- clinical_IPSSM %>%
  mutate(DNMT3A = ifelse(DNMT3A == 1, "mutated", "WT"),
         IPSSM_cat = ifelse(IPSSM_col %in% c("Very-Low", "Low"), "Very-Low/Low", "Moderate/High/Very-High")) 
lapply(c("Very-Low/Low", "Moderate/High/Very-High"), function(cat){
  tmp <- subset(dnmt3a_df2, IPSSM_cat == cat)
 survfit(formula = Surv(OS_YEARS,OS_STATUS) ~ DNMT3A, data = tmp) %>%
    ggsurvplot(data = tmp, facet.by = "clust", 
               surv.median.line = "hv") +
   ggtitle(cat)
 
})
```

```{r}
dnmt3a_low_test <- lapply(main_clusts, function(cl){
    tmp <- mutate(main_low,
             cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster*DNMT3A + AGE + SEX + IPSSM, tmp, subset = IPSSM %in% c("Low", "Very-Low")))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
dnmt3a_low_test %>%
    filter(HR > 1 & Comp_clust %in% paste0(main_clusts, ":DNMT3A")   ) %>%
    arrange(P_value)
```
Pacientes low WBC tienen mucho más riesgo si tienen TET2 en los sub-grupos Low y very-low.



```{r}
dnmt3a_modhigh_test <- lapply(main_clusts, function(cl){
    tmp <- mutate(main_low,
             cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster*DNMT3A + AGE + SEX + IPSSM, tmp, subset = !IPSSM %in% c("Low", "Very-Low")))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
dnmt3a_modhigh_test %>%
    filter(HR > 1 & Comp_clust %in% paste0(main_clusts, ":DNMT3A")   ) %>%
    arrange(P_value)
```

### SRSF2

```{r}
srsf2_test <- lapply(main_clusts, function(cl){
    tmp <- mutate(main_low, 
             cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster*SRSF2 + AGE + SEX + IPSSM, tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
srsf2_test %>%
    filter(HR > 1 & Comp_clust %in% paste0(main_clusts, ":SRSF2")   ) %>%
    arrange(P_value)
```



```{r}
srsf2_test2 <- lapply(main_clusts, function(cl){
    tmp <- mutate(main_low, 
             cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster*SRSF2 + AGE + SEX + IPSSR, tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
srsf2_test2 %>%
    filter(HR > 1 & Comp_clust %in% paste0(main_clusts, ":SRSF2")   ) %>%
    arrange(P_value)
```

```{r}
srsf2_df <- main_low %>%
  mutate(SRSF2 = ifelse(SRSF2 == 1, "mutated", "WT")) 
survfit(formula = Surv(OS_YEARS,OS_STATUS) ~ SRSF2, data = srsf2_df) %>%
    ggsurvplot(data = srsf2_df, facet.by = "clust", 
               surv.median.line = "hv") 

```
No se ven diferencias.

### U2AF1 

```{r}
u2af1_test <- lapply(main_clusts, function(cl){
    tmp <- mutate(main_low,
             cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster*U2AF1 + AGE + SEX + IPSSM, tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
u2af1_test %>%
    filter(HR > 1 & Comp_clust %in% paste0(main_clusts, ":U2AF1")   ) %>%
    arrange(P_value)
```


```{r}
u2af1_test2 <- lapply(main_clusts, function(cl){
    tmp <- mutate(main_low,
             cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster*U2AF1 + AGE + SEX + IPSSR, tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
u2af1_test2 %>%
    filter(HR > 1 & Comp_clust %in% paste0(main_clusts, ":U2AF1")   ) %>%
    arrange(P_value)
```


### RUNX1 

```{r}
runx1_test <- lapply(main_clusts, function(cl){
    tmp <- mutate(main_low,
             cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster*RUNX1 + AGE + SEX + IPSSM, tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
runx1_test %>%
    filter(HR > 1 & Comp_clust %in% paste0(main_clusts, ":RUNX1")   ) %>%
    arrange(P_value)
```

```{r}
runx1_test2 <- lapply(main_clusts, function(cl){
    tmp <- mutate(main_low,
             cluster = relevel(clust, cl))
    os <- summary(coxph(Surv(OS_YEARS,OS_STATUS) ~ cluster*RUNX1 + AGE + SEX + IPSSR, tmp))
     coefs <- os$coefficients
     coef_df <- as_tibble(coefs[, c(1, 5)]) %>%
       mutate(Ref_cluster = cl, 
              Comp_clust = gsub("cluster", "", rownames(coefs)),
              HR = exp(coef))
     colnames(coef_df)[2] <- "P_value"
     
     select(coef_df, Ref_cluster, Comp_clust, HR, P_value)
    }) %>%
    Reduce(., f = rbind) 
runx1_test2 %>%
    filter(HR > 1 & Comp_clust %in% paste0(main_clusts, ":RUNX1")   ) %>%
    arrange(P_value)
```

```{r}
runx1_df <- main_low %>%
  mutate(RUNX1 = ifelse(SRSF2 == 1, "mutated", "WT")) 
survfit(formula = Surv(OS_YEARS,OS_STATUS) ~ RUNX1, data = runx1_df) %>%
    ggsurvplot(data = runx1_df, facet.by = "clust", 
               surv.median.line = "hv") 

```

No se ven diferencias.